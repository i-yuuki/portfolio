---
title: "エコーと不思議な図書館"
dates:
  start: "2021-10-15"
  end: "2021-11-15"
languages:
  - "C#"
recommend: 5000
summary: "Unity アクションゲーム"
banner: "/images/echo/banner.jpg"
links:
  - text: PVを見る
    href: https://drive.google.com/file/d/13_w9ZYmlviMuinHUlOo4i8zosEZspCdm/view?usp=sharing
  - text: 実行ファイルをダウンロード (Coming Soon)
    href: https://example.com/
  - text: ソースコードを見る (Coming Soon)
    href: https://github.com/i-yuuki/echo-game/
---

# エコーと不思議な図書館

エコーと不思議な図書館 (Echo and the Silent Library) は、図書館に突如現れたモンスターの攻撃をはね返して戦い、静かな図書館を取り戻すゲームです。

作ったモデルをゲームに入れてポートフォリオに載せたいと集まったデザイナー10人に唯一のプログラマーとして加わったチームによる学校課題と関係のない制作で、実装すべてを担当しました。

後に[ゲームクリエイター甲子園](https://game.creators-guild.com/gck2021/)への出品が目標に追加され、[一応掲載されました](https://game.creators-guild.com/gck2021/2289/) (動画スクショめちゃ古～いけど本体最新です！)。

このページはちょっとテンション高めです。

## コードのこだわり

ゲームデザインにはほぼ介入せず、ソースコードへのこだわりに集中した作品です。この頃にあったインターンシップでMVPパターンなどを学んだことを活かしました。これまでのUnity制作は解説動画丸写しのお粗末なものが多かったので、実際のゲームにありそうなコードを目指し、イベントや非同期処理にコンポジションを取り入れました。コードそのものも自分史上最もきれいな見やすいUnityプログラムになりました。

### イベント

UniRxという便利ライブラリを知ってしまい、解除が面倒で避けてきたイベントが楽になったので、各クラスにあまり多くの機能をつけず、イベントでつなげることを意識しました。

```cs
// before: プレイヤーにHP表示機能がついてる
class Player : MonoBehaviour{
  Slider healthDisplay;
}
// after: プレイヤーはHP持つだけ、表示はHP変更監視してまあがんばれ
class Player : MonoBehaviour{
  IObservable<int> OnHealthChange;
}
// がんばる
class PlayerHealthDisplay : MonoBehaviour{
  Player player;
  void Start(){
    // AddToで自動解除！べんり！
    player.OnHealthChange.Subscribe(Hoge).AddTo(this);
  }
}
```

### コンポジション

敵などを作るとき、これまではなんでも継承でやってきましたが、機能を別クラスにわけて参照するコンポジションなるものがあるらしいので試しました。必要な機能だけを持たせられるようになりました。この辺もうちょっと詰められたかも。

### 小物

今回はプログラマーが自分だけでしたが、`sealed class`・`readonly`・`private` など地味に役立ちそうな安全対策 (他の人や未来の自分に勝手に継承させない、書き換えさせない、など) をしたり、名前空間やコードスタイルを心がけたりしました。C++ より C# のほうがクラスが見やすいような気がするのは私だけでしょうか。

## 制作の流れ (と真の制作期間)

せっかくなので語ります。

実際に甲子園に出したものの実作業にかけた1か月を実装期間と表記しましたが、実はその前に9か月もの壮絶なゲームデザインわからん地獄がありました (チームに企画専攻いないのやばい)。これを含めると10か月かけてるんですね。

最初にみんなで案出しをし採用されたのは「敵の攻撃をタイミングよく反射して進むリズムアクション」ものでした。これをもとに、BGMの拍にあわせてキーを押すと敵が撃ってくる弾を跳ね返せるプロトタイプを作りました。

<figure>
  <video src="/videos/echo/prototype2.webm" controls playsinline></video>
  <figcaption>プロトタイプ2 (音付き)</figcaption>
</figure>

ここからゆっくりと進んでいく企画にあわせ、謎にプロトタイプをバージョン11まで更新していきました。結局リズム要素は消失し、自動スクロールするステージでひたすら弾を跳ね返し、敵を倒してパワーアップしたり特定のオブジェクトにあててギミックを発動したりする感じになりました。

プロトタイプ6あたりから送られてくる素材も本格化し、誰もがこれで本制作と思っていたその時！

甲子園締め切り1か月前を切った10月23日、企画が変わり、作り直しを決めました！！

新しい案は自動スクロールなし、自由に移動可能、部屋の敵をすべて倒して次の部屋に進むものでした。

突然始まった1か月ゲーム制作チャレンジ、謎に勢いをつけて突入していきます。企画変更のボイスチャットを聞きながら「できるだけシンプルに」とお願いしつつ、その場でプロトタイプを作り直して確認を取りました。その後勢いを保って敵の再実装などを進め、2週間を切った11月からは部屋など新たに必要になったモデルが1日1つのハイペースで上がってくるなど全員本気でかかりました。

<figure>
  <video src="/videos/echo/new-prototype.webm" controls playsinline></video>
  <figcaption>新プロトタイプ</figcaption>
</figure>

そんな中遅かったのが仕様です。スプレッドシートがあったのですが、内容がほぼ企画変更前で止まっていて、内容もざっくりしていました。そこで「仕様掘り出し所」を開設して欲しい情報を伝え、また毎日ビルドを共有し実際に動かしながら意見をもらいました。これが抜群に効き、最初の9か月とは比べ物にならない超高速で仕様をまとめていくことができました。

207コミット後……無事に甲子園に出品することができましたたとさ。めでたしめでたし。
